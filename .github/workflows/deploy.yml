name: CI/CD Portfolio

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ R√©cup√©ration du code source
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2Ô∏è‚É£ Connexion √† Docker Hub
      # -------------------------------
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # -------------------------------
      # 3Ô∏è‚É£ Construction & push du frontend
      # -------------------------------
      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/devops-frontend:latest
          file: ./frontend/Dockerfile

      # -------------------------------
      # 4Ô∏è‚É£ D√©ploiement automatique sur serveur local
      # -------------------------------
      - name: Deploy to local server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "=== üöÄ D√©ploiement local en cours ==="

            DEPLOY_PATH="/home/${{ secrets.SERVER_USER }}/DevOps/devops-portfolio"
            REPO_URL="https://github.com/<ton-username>/<ton-repo>.git"

            # üîß Cr√©er le dossier si besoin
            mkdir -p $DEPLOY_PATH
            cd $DEPLOY_PATH

            # üîÑ Cloner ou mettre √† jour le d√©p√¥t
            if [ ! -d .git ]; then
              echo "üì¶ Clonage initial du d√©p√¥t..."
              git clone $REPO_URL .
            else
              echo "üîÅ Mise √† jour du d√©p√¥t..."
              git pull
            fi

            # üê≥ D√©ploiement Docker
            echo "üì¶ Lancement du d√©ploiement Docker..."
            docker compose pull
            docker compose up -d --force-recreate

            echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
